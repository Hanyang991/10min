<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>10ì´ˆ ì•ˆì— ë©ˆì¶”ì„¸ìš”! (ì‹¬ë¦¬ì „ ë²„ì „)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€â”€ RESET & ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0f0f1a;
  --accent: #00fff5;
  --accent2: #e94560;
  --text: #eee;
  --card-bg: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.08);
  --glow: 0 0 20px rgba(0,255,245,0.3);
}

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.6s ease;
  position: relative;
}

/* â”€â”€â”€ FLOATING PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.particle {
  position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; opacity: 0.15;
  animation: floatP 8s ease-in-out infinite;
}
@keyframes floatP {
  0%,100% { transform: translateY(0) scale(1); opacity: 0.15; }
  50%     { transform: translateY(-40px) scale(1.2); opacity: 0.3; }
}

/* â”€â”€â”€ FLOATING ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.float-icon {
  position: absolute; font-size: 2.2rem; pointer-events: none; z-index: 2;
  animation: iconPop 0.3s cubic-bezier(.175,.885,.32,1.275) forwards;
  text-shadow: 0 0 12px rgba(255,255,255,0.6); transition: opacity 0.4s;
}
@keyframes iconPop { from { transform: scale(0) rotate(-20deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }
.float-icon.target-icon { animation: iconPopGlow 0.3s cubic-bezier(.175,.885,.32,1.275) forwards; filter: drop-shadow(0 0 14px #fff); }
@keyframes iconPopGlow { from { transform: scale(0) rotate(-20deg); opacity: 0; } to { transform: scale(1.3) rotate(5deg); opacity: 1; } }

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 24px 16px; }

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header { text-align: center; margin-bottom: 8px; }
.header h1 {
  font-family: 'Orbitron', sans-serif; font-size: 1.9rem; font-weight: 900; letter-spacing: 3px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.header .sub { font-size: 0.85rem; color: #888; letter-spacing: 2px; margin-top: 2px; }

/* â”€â”€â”€ PLAYER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.player-bar { display: flex; gap: 20px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; justify-content: center; }
.player-bar .pinfo { font-size: 0.82rem; color: #aaa; }
.player-bar .pinfo span { color: var(--accent); font-weight: 700; }

/* â”€â”€â”€ STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.strip {
  display: flex; align-items: center; gap: 28px; margin-bottom: 10px;
  background: var(--card-bg); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 10px 28px; backdrop-filter: blur(6px);
}
.strip .stage-label { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; color: #777; text-transform: uppercase; letter-spacing: 2px; }
.strip .stage-val  { font-family: 'Orbitron', sans-serif; font-size: 1.6rem; font-weight: 700; color: var(--accent); }
.strip .divider    { width: 1px; height: 36px; background: var(--card-border); }
.timer-wrap        { text-align: center; }
.timer-label       { font-size: 0.7rem; color: #666; letter-spacing: 2px; text-transform: uppercase; }
.timer-val {
  font-family: 'Share Tech Mono', monospace; font-size: 2.4rem; font-weight: 700;
  color: var(--accent); text-shadow: var(--glow); transition: color 0.3s;
}
.timer-val.danger { color: var(--accent2); text-shadow: 0 0 20px rgba(233,69,96,0.5); }

/* â”€â”€â”€ MISSION CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mission-card {
  width: 100%; max-width: 680px; background: var(--card-bg);
  border: 1px solid var(--card-border); border-radius: 16px;
  padding: 14px 22px; margin-bottom: 14px; backdrop-filter: blur(6px);
  text-align: center; position: relative; overflow: hidden;
}
.mission-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}
.mission-label { font-size: 0.7rem; color: #666; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px; }
.mission-text { font-size: 1.15rem; font-weight: 500; color: #eee; }
.mission-text strong { color: var(--accent); font-weight: 700; }

/* â”€â”€â”€ CLOCK GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.clock-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 14px; width: 100%; max-width: 720px; margin-bottom: 18px; }
.clock-card {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px;
  padding: 16px 10px 12px; text-align: center; position: relative; overflow: hidden;
  transition: border-color 0.35s, box-shadow 0.35s, transform 0.2s; min-width: 140px; flex: 0 1 auto;
}
.clock-card:hover { transform: translateY(-2px); }
.clock-card.highlighted {
  border-color: var(--accent); box-shadow: 0 0 18px rgba(0,255,245,0.25), inset 0 0 30px rgba(0,255,245,0.05);
}
.clock-card .clock-label { font-size: 0.68rem; letter-spacing: 2px; color: #666; text-transform: uppercase; margin-bottom: 10px; }

/* ì‹œê³„ ìŠ¤íƒ€ì¼ë“¤ */
.digital-clock { font-family: 'Share Tech Mono', monospace; font-size: 1.7rem; font-weight: 700; color: var(--accent); text-shadow: var(--glow); letter-spacing: 2px; }
.analog-svg { width: 100px; height: 100px; margin: 0 auto; }
.binary-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 2px 6px; justify-items: center; }
.binary-col { display: flex; flex-direction: column; gap: 3px; }
.bit { width: 18px; height: 18px; border-radius: 4px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); transition: background 0.2s; }
.bit.on { background: var(--accent); box-shadow: 0 0 6px rgba(0,255,245,0.5); }
.flip-display { display: flex; gap: 4px; justify-content: center; }
.flip-digit {
  background: linear-gradient(180deg, #1e1e2e 50%, #16161f 50%); border-radius: 6px; width: 28px; height: 38px;
  display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', monospace; font-size: 1.15rem; font-weight: 700; color: #eee;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.06); position: relative;
}
.flip-digit::after { content: ''; position: absolute; top: 50%; left: 4%; right: 4%; height: 1px; background: rgba(255,255,255,0.1); }
.flip-sep { font-size: 1.2rem; color: #555; align-self: center; margin: 0 1px; }
.neon-clock { font-family: 'Orbitron', sans-serif; font-size: 1.55rem; font-weight: 900; color: #fff; text-shadow: 0 0 7px var(--accent2), 0 0 20px var(--accent2); letter-spacing: 3px; }

/* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-row { display: flex; gap: 14px; justify-content: center; margin-bottom: 14px; }
.btn-stop {
  font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 700; letter-spacing: 2px;
  padding: 14px 40px; border: none; border-radius: 50px; cursor: pointer;
  background: linear-gradient(135deg, var(--accent2), #c0392b); color: #fff;
  box-shadow: 0 4px 20px rgba(233,69,96,0.4); transition: transform 0.15s; position: relative; overflow: hidden;
}
.btn-stop:hover { transform: scale(1.05); } .btn-stop:active { transform: scale(0.97); }
.btn-stop:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
.btn-stop .ripple { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.35); transform: scale(0); animation: ripple 0.6s linear; pointer-events: none; }
@keyframes ripple { to { transform: scale(4); opacity: 0; } }

.btn-next {
  font-family: 'Orbitron', sans-serif; font-size: 0.85rem; font-weight: 700; padding: 12px 32px;
  border: 2px solid var(--accent); border-radius: 50px; background: transparent; color: var(--accent);
  cursor: pointer; transition: all 0.2s; display: none;
}
.btn-next:hover { background: var(--accent); color: #0f0f1a; }

/* â”€â”€â”€ RESULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 100;
  display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.result-overlay.show { opacity: 1; pointer-events: auto; }
.result-box {
  background: #1a1a2e; border: 1px solid var(--card-border); border-radius: 24px; padding: 40px 44px;
  text-align: center; max-width: 380px; width: 90%; transform: scale(0.92); transition: transform 0.3s;
}
.result-overlay.show .result-box { transform: scale(1); }
.result-emoji { font-size: 3.2rem; margin-bottom: 8px; }
.result-title { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 6px; }
.result-title.correct { color: var(--accent); } .result-title.wrong { color: var(--accent2); }
.result-desc { font-size: 0.88rem; color: #999; margin-bottom: 20px; line-height: 1.5; }
.btn-retry {
  background: linear-gradient(135deg, var(--accent2), #c0392b); color: #fff; border:none; padding:10px 24px; border-radius:50px; cursor:pointer; font-weight:600; font-family:'Rajdhani';
}
.btn-leaderboard { background: var(--card-bg); border: 1px solid var(--card-border); color: #aaa; margin-top:10px; padding:8px 20px; border-radius:20px; cursor:pointer; }

/* â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.login-overlay, .lb-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.82); backdrop-filter: blur(6px); z-index: 200; display: flex; align-items: center; justify-content: center; }
.login-box, .lb-box { background: #1a1a2e; border: 1px solid var(--card-border); border-radius: 24px; padding: 32px; text-align: center; width: 90%; max-width: 360px; }
.hidden { display: none !important; }

/* â”€â”€â”€ START SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.start-screen { position: fixed; inset: 0; background: #0f0f1a; z-index: 180; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; }
.start-screen h1 { font-family: 'Orbitron', sans-serif; font-size: 2.6rem; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; }
.btn-play { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700; padding: 16px 52px; border: none; border-radius: 50px; background: linear-gradient(135deg, var(--accent), #00b8d0); color: #0f0f1a; cursor: pointer; margin-bottom: 16px; }

/* MISC */
input { width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; border-radius: 8px; }
</style>
</head>
<body>

<div class="start-screen" id="startScreen">
  <h1>â± 10ì´ˆ: í•¨ì • í”¼í•˜ê¸°</h1>
  <p style="color:#777; margin-bottom:30px;">
    ì£¼ì–´ì§„ ì¡°ê±´ì´ ë“±ì¥í•  ë•Œë§Œ ëˆ„ë¥´ì„¸ìš”.<br/>
    <strong style="color:#e94560">í•¨ì •(ê±°ì§“ ì¡°ê±´)</strong>ì´ë¼ë©´ 10ì´ˆ ë™ì•ˆ ë²„í‹°ì„¸ìš”!
  </p>
  <button class="btn-play" onclick="startGame()">GAME START</button>
  <button style="background:none; border:1px solid #444; color:#888; padding:8px 20px; border-radius:20px; cursor:pointer;" onclick="openLeaderboard()">ğŸ† ë­í‚¹</button>
</div>

<div class="login-overlay hidden" id="loginOverlay">
  <div class="login-box">
    <h2 style="color:var(--accent); font-family:'Orbitron'; margin-bottom:10px;">PLAYER NAME</h2>
    <input type="text" id="nameInput" placeholder="ë‹‰ë„¤ì„..." maxlength="12" onkeydown="if(event.key==='Enter')doLogin()" />
    <button class="btn-play" style="width:100%; padding:10px;" onclick="doLogin()">START</button>
  </div>
</div>

<div id="app" class="hidden">
  <div class="header">
    <h1>â± 10ì´ˆ</h1>
    <div class="sub">ì‹¬ë¦¬ì „ ì—ë””ì…˜</div>
  </div>

  <div class="player-bar">
    <div class="pinfo">Player: <span id="playerName">â€”</span></div>
    <div class="pinfo">Best: <span id="bestStage">0</span></div>
  </div>

  <div class="strip">
    <div><div class="stage-label">Stage</div><div class="stage-val" id="stageVal">1</div></div>
    <div class="divider"></div>
    <div class="timer-wrap">
      <div class="timer-label">Time</div>
      <div class="timer-val" id="timerVal">10.00</div>
    </div>
    <div class="divider"></div>
    <div><div class="stage-label">Score</div><div class="stage-val" id="scoreVal">0</div></div>
  </div>

  <div class="mission-card">
    <div class="mission-label">MISSION</div>
    <div class="mission-text" id="missionText">Loading...</div>
  </div>

  <div class="clock-grid" id="clockGrid"></div>

  <div class="btn-row">
    <button class="btn-stop" id="btnStop" onclick="handleAction(event, true)">
      STOP
      <span style="display: block; font-size: 0.65rem; opacity: 0.7; margin-top: 2px;">SPACE / TOUCH</span>
    </button>
    <button class="btn-next" id="btnNext" onclick="nextStage()">NEXT STAGE â†’</button>
  </div>
</div>

<div class="result-overlay" id="resultOverlay">
  <div class="result-box">
    <div class="result-emoji" id="resultEmoji">âœ…</div>
    <div class="result-title correct" id="resultTitle">ì •ë‹µ!</div>
    <div class="result-desc" id="resultDesc"></div>
    <div style="display:flex; justify-content:center; gap:10px;">
      <button class="btn-retry" id="btnRetry" onclick="retryStage()">ì¬ë„ì „ (Stage 1)</button>
      <button class="btn-next" id="resultNext" style="display:none;" onclick="nextStage()">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
    </div>
    <button class="btn-leaderboard" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
  </div>
</div>

<div class="lb-overlay hidden" id="lbOverlay">
  <div class="lb-box">
    <h2 style="color:var(--accent); font-family:'Orbitron'; margin-bottom:20px;">TOP 20</h2>
    <div id="lbList" style="text-align:left; max-height:300px; overflow-y:auto; margin-bottom:20px; font-size:0.9rem;"></div>
    <button class="btn-leaderboard" onclick="document.getElementById('lbOverlay').classList.add('hidden')">ë‹«ê¸°</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE = "/api";
let STATE = {
  playerId: null, playerName: "",
  stage: 1, score: 0,
  event: null, theme: null,
  
  // Schedules
  bgSchedule: [], iconSchedule: [], clockHighlightSchedule: [], clockColorSchedule: [],
  effects: [], clocks: [],
  
  // Runtime State
  timer: null, timeLeft: 10.00, running: false, stopped: false,
  startTime: null,
  currentH: 0, currentM: 0, currentS: 0,
  
  // Interaction State
  spacebarCount: 0,
  rapidTaps: [], rapidStarted: false, rapidStartTime: 0,
  pressStart: null, pressStartTime: 0, pressDuration: 0,
  redAppeared: false, rhythmTaps: [], blinkTimes: [],
  
  // Active Visuals
  activeBg: null, activeIcons: [], activeHighlight: null, activeClockColor: null
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function startGame() {
  document.getElementById("startScreen").classList.add("hidden");
  document.getElementById("loginOverlay").classList.remove("hidden");
  document.getElementById("nameInput").focus();
}

async function doLogin() {
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return;
  try {
    const res = await fetch(BASE + "/register", { method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({name}) });
    const data = await res.json();
    STATE.playerId = data.player_id;
    STATE.playerName = data.name;
    document.getElementById("playerName").textContent = data.name;
    document.getElementById("loginOverlay").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    fetchBest();
    beginStage(1);
  } catch(e) { alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"); }
}

async function fetchBest() {
  try {
    const res = await fetch(BASE + "/my_best?player_id=" + STATE.playerId);
    const data = await res.json();
    document.getElementById("bestStage").textContent = data.max_stage;
  } catch(e){}
}

async function beginStage(stage) {
  STATE.stage = stage;
  STATE.running = false; STATE.stopped = false;
  STATE.timeLeft = 10.00;
  
  // State Reset
  STATE.spacebarCount = 0;
  STATE.rapidTaps = []; STATE.rapidStarted = false;
  STATE.pressStart = null; STATE.pressDuration = 0;
  STATE.redAppeared = false; STATE.rhythmTaps = []; STATE.blinkTimes = [];
  STATE.activeBg = null; STATE.activeIcons = []; STATE.activeHighlight = null; STATE.activeClockColor = null;

  // UI Reset
  hideResult();
  document.getElementById("stageVal").textContent = stage;
  document.getElementById("scoreVal").textContent = STATE.score;
  document.getElementById("timerVal").textContent = "10.00";
  document.getElementById("timerVal").classList.remove("danger");
  document.getElementById("btnStop").disabled = false;
  document.getElementById("btnNext").style.display = "none";
  document.getElementById("missionText").textContent = "Loading...";
  document.body.style.background = "";
  
  // Fetch New Event
  try {
    const res = await fetch(BASE + "/new_event?stage=" + stage);
    const data = await res.json();
    
    STATE.event = data.event;
    STATE.theme = data.theme;
    STATE.clocks = data.clocks;
    
    STATE.bgSchedule = data.bg_schedule || [];
    STATE.iconSchedule = data.icon_schedule || [];
    STATE.clockHighlightSchedule = data.clock_highlight_schedule || [];
    STATE.clockColorSchedule = data.clock_color_schedule || [];
    STATE.effects = data.effects || [];

    // Theme Apply
    document.body.style.background = data.theme.bg;
    document.documentElement.style.setProperty("--accent", data.theme.accent);
    document.documentElement.style.setProperty("--bg", data.theme.bg);

    renderMission(data.event.description);
    renderClocks(data.clocks);
    applyEffects(STATE.effects);

    // Start Timer
    STATE.startTime = Date.now();
    STATE.running = true;
    startTimer();
    
  } catch(e) { document.getElementById("missionText").textContent = "Error loading stage"; }
}

function renderMission(desc) {
  document.getElementById("missionText").innerHTML = desc.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
}

function renderClocks(types) {
  const grid = document.getElementById("clockGrid");
  const tpl = {
    digital: `<div class="clock-card" data-type="digital"><div class="clock-label">Digital</div><div class="digital-clock" id="digitalClock">00:00:00</div></div>`,
    analog: `<div class="clock-card" data-type="analog"><div class="clock-label">Analog</div><svg class="analog-svg" id="analogClock" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/><line id="hourHand" x1="50" y1="50" x2="50" y2="22" stroke="white" stroke-width="2.5"/><line id="minHand" x1="50" y1="50" x2="50" y2="16" stroke="rgba(255,255,255,0.8)" stroke-width="1.8"/><line id="secHand" x1="50" y1="50" x2="50" y2="12" stroke="var(--accent2)" stroke-width="1"/></svg></div>`,
    binary: `<div class="clock-card" data-type="binary"><div class="clock-label">Binary</div><div class="binary-grid" id="binaryClock"></div></div>`,
    flip: `<div class="clock-card" data-type="flip"><div class="clock-label">Flip</div><div class="flip-display" id="flipClock"></div></div>`,
    neon: `<div class="clock-card" data-type="neon"><div class="clock-label">Neon</div><div class="neon-clock" id="neonClock">00:00:00</div></div>`
  };
  grid.innerHTML = types.map(t => tpl[t]).join("");
}

function startTimer() {
  if (STATE.timer) clearInterval(STATE.timer);
  let _bgIdx=0, _iconIdx=0, _hlIdx=0, _colIdx=0;
  
  STATE.timer = setInterval(() => {
    if (!STATE.running) { clearInterval(STATE.timer); return; }
    
    const elapsed = (Date.now() - STATE.startTime) / 1000;
    STATE.timeLeft = Math.max(0, 10 - elapsed);
    document.getElementById("timerVal").textContent = STATE.timeLeft.toFixed(2);
    if (STATE.timeLeft <= 3) document.getElementById("timerVal").classList.add("danger");

    // Process Schedules
    while (_bgIdx < STATE.bgSchedule.length && elapsed >= STATE.bgSchedule[_bgIdx].at) {
      STATE.activeBg = STATE.bgSchedule[_bgIdx].color;
      document.body.style.background = STATE.activeBg;
      if (STATE.event?.type==='dont_click' && STATE.activeBg==='#e74c3c') STATE.redAppeared=true;
      _bgIdx++;
    }
    while (_iconIdx < STATE.iconSchedule.length && elapsed >= STATE.iconSchedule[_iconIdx].at) {
      spawnIcon(STATE.iconSchedule[_iconIdx]);
      _iconIdx++;
    }
    while (_hlIdx < STATE.clockHighlightSchedule.length && elapsed >= STATE.clockHighlightSchedule[_hlIdx].at) {
      STATE.activeHighlight = STATE.clockHighlightSchedule[_hlIdx].clock;
      document.querySelectorAll(".clock-card").forEach(c => c.classList.remove("highlighted"));
      const t = document.querySelector(`.clock-card[data-type="${STATE.activeHighlight}"]`);
      if(t) t.classList.add("highlighted");
      _hlIdx++;
    }
    while (_colIdx < STATE.clockColorSchedule.length && elapsed >= STATE.clockColorSchedule[_colIdx].at) {
      STATE.activeClockColor = STATE.clockColorSchedule[_colIdx].color;
      applyClockColor(STATE.activeClockColor);
      _colIdx++;
    }

    updateClocks();

    if (STATE.timeLeft <= 0) {
      clearInterval(STATE.timer);
      STATE.running = false;
      timeUp();
    }
  }, 40);
}

function updateClocks() {
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds(), ms = now.getMilliseconds();
  STATE.currentH = h; STATE.currentM = m; STATE.currentS = s;
  
  const pad = n => String(n).padStart(2,"0");
  const timeStr = `${pad(h)}:${pad(m)}:${pad(s)}`;
  
  // Digital/Neon
  const dEl = document.getElementById("digitalClock"); if(dEl) dEl.textContent = timeStr;
  const nEl = document.getElementById("neonClock"); if(nEl) nEl.textContent = timeStr;
  
  // Analog
  const setHand = (id, deg, len) => {
    const el = document.getElementById(id); if(!el) return;
    const rad = (deg - 90) * Math.PI / 180;
    el.setAttribute("x2", 50 + len * Math.cos(rad));
    el.setAttribute("y2", 50 + len * Math.sin(rad));
  };
  setHand("hourHand", ((h%12)+m/60)*30, 22);
  setHand("minHand", (m+s/60)*6, 28);
  setHand("secHand", (s+ms/1000)*6, 32);

  // Binary
  const bEl = document.getElementById("binaryClock");
  if(bEl) {
    const units = [Math.floor(h/10), h%10, Math.floor(m/10), m%10, Math.floor(s/10), s%10];
    bEl.innerHTML = units.map(val => `<div class="binary-col">${val.toString(2).padStart(4,"0").split("").map(b => `<div class="bit ${b==="1"?"on":""}"></div>`).join("")}</div>`).join("");
  }
  
  // Flip
  const fEl = document.getElementById("flipClock");
  if(fEl) fEl.innerHTML = (pad(h)+pad(m)+pad(s)).split("").map((d,i)=>`<div class="flip-digit">${d}</div>${(i===1||i===3)?'<div class="flip-sep">:</div>':''}`).join("");

  // Fake Clock
  const fakeEl = document.getElementById('fakeClock');
  if(fakeEl) {
    let fs = s+1, fm = m, fh = h;
    if(fs>=60){ fs=0; fm++; if(fm>=60){ fm=0; fh=(fh+1)%24; } }
    fakeEl.textContent = `${pad(fh)}:${pad(fm)}:${pad(fs)}`;
  }
  
  // Rapid Tap Logic
  if (STATE.event?.type === 'rapid_tap' && s === 0 && !STATE.rapidStarted) {
    STATE.rapidStarted = true; STATE.rapidTaps = []; STATE.rapidStartTime = Date.now();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER VERIFICATION (KEY LOGIC)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function verifyWithServer(clicked) {
  const stoppedAt = (Date.now() - STATE.startTime) / 1000;
  
  try {
    const res = await fetch(BASE + "/verify", {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        event: STATE.event,
        stopped_at: stoppedAt,
        current_time: { h: STATE.currentH, m: STATE.currentM, s: STATE.currentS },
        active_bg_color: STATE.activeBg,
        active_icons: STATE.activeIcons,
        active_highlight: STATE.activeHighlight,
        active_clock_color: STATE.activeClockColor,
        spacebar_count: STATE.spacebarCount,
        rapid_taps: STATE.rapidTaps,
        press_start: STATE.pressStart,
        press_duration: STATE.pressDuration,
        red_appeared: STATE.redAppeared,
        clicked: clicked, // â˜… í•µì‹¬: í´ë¦­ ì—¬ë¶€ ì „ì†¡
        rhythm_taps: STATE.rhythmTaps,
        blink_times: STATE.blinkTimes,
      })
    });
    const data = await res.json();
    
    if (data.correct) {
      STATE.totalCorrect || (STATE.totalCorrect=0); STATE.totalCorrect++;
      showResult(true, "ì •ë‹µ!", data.msg || `ìŠ¤í…Œì´ì§€ ${STATE.stage} í´ë¦¬ì–´!`);
    } else {
      STATE.totalWrong || (STATE.totalWrong=0); STATE.totalWrong++;
      let msg = data.msg || "ì¡°ê±´ ë¶ˆì¼ì¹˜";
      if(data.expected_time) msg += `<br/><br/>â° ì •ë‹µì‹œê°: ${data.expected_time}`;
      if(data.answer) msg += `<br/>ğŸ’¡ íŒíŠ¸: ${data.answer}`;
      showResult(false, "ì‹¤íŒ¨!", msg);
      saveRecord();
    }
  } catch(e) { showResult(false, "ì˜¤ë¥˜", "í†µì‹  ì‹¤íŒ¨"); }
}

function timeUp() {
  STATE.stopped = true;
  document.getElementById("btnStop").disabled = true;
  // ì‹œê°„ ëë‚  ë•Œê¹Œì§€ ì•ˆ ëˆŒë €ìŒ (clicked: false) -> ì„œë²„ê°€ í•¨ì • ì—¬ë¶€ íŒë‹¨
  verifyWithServer(false);
}

function handleAction(e, isBtn=false) {
  if(!STATE.running || STATE.stopped) return;
  if(e) e.preventDefault();
  
  STATE.spacebarCount++;
  
  // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì¦‰ì‹œ í”¼ë“œë°±ì´ í•„ìš”í•œ ê²½ìš° (ì˜ˆ: ì—°íƒ€ ì¹´ìš´íŠ¸ í‘œì‹œ)
  if(STATE.event?.type === 'spacebar_count') showSpacebarFeedback();
  
  // ì¼ë°˜ì ì¸ 'ë©ˆì¶¤' ë™ì‘ì€ ì„œë²„ë¡œ ê²€ì¦
  if(STATE.event?.type !== 'spacebar_count' && STATE.event?.type !== 'rapid_tap' && STATE.event?.type !== 'rhythm_tap') {
    onStop();
  }
}

function onStop() {
  if(!STATE.running || STATE.stopped) return;
  const btn = document.getElementById("btnStop");
  btn.classList.add("ripple"); setTimeout(()=>btn.classList.remove("ripple"), 600);
  
  STATE.running = false;
  STATE.stopped = true;
  clearInterval(STATE.timer);
  btn.disabled = true;
  
  // ëˆŒë €ìŒ (clicked: true) -> ì„œë²„ê°€ ì¡°ê±´ ì¼ì¹˜ ì—¬ë¶€ íŒë‹¨
  verifyWithServer(true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUAL & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function applyEffects(effects) {
  document.querySelectorAll('.clock-card').forEach(c => { c.style.filter=''; c.style.transform=''; });
  document.querySelectorAll('.fake-clock').forEach(e=>e.remove());
  
  effects.forEach(eff => {
    if(eff.type==='fog') document.querySelectorAll('.clock-card').forEach(c => { c.style.filter='blur(3px)'; c.style.opacity='0.6'; });
    if(eff.type==='mirror') document.querySelectorAll('.clock-card').forEach(c => c.style.transform='scaleX(-1)');
    if(eff.type==='fake_clock') {
      const g = document.getElementById('clockGrid');
      g.insertAdjacentHTML('beforeend', `<div class="clock-card fake-clock" style="border-color:#ff6b6b"><div class="clock-label">âš ï¸ FAKE</div><div class="digital-clock" id="fakeClock" style="color:#ff6b6b">00:00:00</div></div>`);
    }
  });
}

function applyClockColor(color) {
  document.querySelectorAll('.clock-card').forEach(c => {
    c.style.borderColor = color;
    c.style.boxShadow = `0 0 25px ${color}, inset 0 0 30px ${color}20`;
  });
}

function spawnIcon(info) {
  const el = document.createElement("div"); el.className = "float-icon";
  if(STATE.event?.type==="icon_appears" && info.icon===STATE.event.detail.target_icon) el.classList.add("target-icon");
  el.textContent = info.icon;
  el.style.left = info.x + "%"; el.style.top = info.y + "%";
  document.body.appendChild(el);
  STATE.activeIcons.push(info.icon);
  setTimeout(()=> { el.style.opacity="0"; setTimeout(()=>el.remove(),400); }, 4000);
}

function showResult(correct, title, desc) {
  const overlay = document.getElementById("resultOverlay");
  document.getElementById("resultEmoji").textContent = correct ? "ğŸ‰" : "ğŸ˜…";
  const tEl = document.getElementById("resultTitle");
  tEl.textContent = title; tEl.className = "result-title " + (correct?"correct":"wrong");
  document.getElementById("resultDesc").innerHTML = desc;
  
  document.getElementById("resultNext").style.display = correct ? "inline-block" : "none";
  document.getElementById("btnRetry").style.display = correct ? "none" : "inline-block";
  overlay.classList.add("show");
}
function hideResult() { document.getElementById("resultOverlay").classList.remove("show"); }

function retryStage() { hideResult(); STATE.score=0; beginStage(1); }
function nextStage() { hideResult(); STATE.score++; beginStage(STATE.stage+1); }
function goHome() { hideResult(); document.getElementById("app").classList.add("hidden"); document.getElementById("startScreen").classList.remove("hidden"); }

async function saveRecord() {
  await fetch(BASE+"/save_record", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({player_id:STATE.playerId, max_stage:STATE.stage, total_correct:STATE.totalCorrect, total_wrong:STATE.totalWrong})});
}

async function openLeaderboard() {
  const res = await fetch(BASE+"/leaderboard");
  const rows = await res.json();
  document.getElementById("lbList").innerHTML = rows.map((r,i)=>`<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333;"><span>#${i+1} ${r.name}</span><span style="color:var(--accent)">Lv.${r.max_stage}</span></div>`).join("");
  document.getElementById("lbOverlay").classList.remove("hidden");
}

function showSpacebarFeedback(txt) {
  const el = document.createElement("div");
  el.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:4rem; color:var(--accent); font-weight:900; z-index:999; animation:pop 0.3s forwards;";
  el.textContent = txt || STATE.spacebarCount;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),300);
}
const style = document.createElement("style"); style.textContent="@keyframes pop { 0%{transform:translate(-50%,-50%) scale(0.5); opacity:0;} 50%{transform:translate(-50%,-50%) scale(1.3); opacity:1;} 100%{transform:translate(-50%,-50%) scale(1); opacity:0;} }"; document.head.appendChild(style);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener("pointerdown", (e) => {
  if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') handleAction(e);
});

document.addEventListener("keydown", (e) => {
  if (e.code === "Space" || e.key === " ") {
    if(e.repeat) return;
    e.preventDefault();
    if(document.getElementById("resultOverlay").classList.contains("show")) {
      document.getElementById("resultNext").style.display!=="none" ? nextStage() : retryStage();
      return;
    }
    
    // Physical Tasks Handling
    if(STATE.running && STATE.event?.type === 'long_press') { STATE.pressStart = STATE.currentS; STATE.pressStartTime = Date.now(); }
    if(STATE.running && STATE.event?.type === 'rapid_tap' && STATE.rapidStarted) {
      if((Date.now()-STATE.rapidStartTime)/1000 <= 1.0) { STATE.rapidTaps.push((Date.now()-STATE.rapidStartTime)/1000); showSpacebarFeedback(`${STATE.rapidTaps.length}/5`); }
      return;
    }
    if(STATE.running && STATE.event?.type === 'rhythm_tap') {
      STATE.rhythmTaps.push((Date.now()-STATE.startTime)/1000); showSpacebarFeedback(`â™ª`);
      return;
    }

    handleAction(e);
  }
});

document.addEventListener("keyup", (e) => {
  if (e.code === "Space" || e.key === " ") {
    if (STATE.running && STATE.event?.type === 'long_press') {
      STATE.pressDuration = (Date.now() - STATE.pressStartTime) / 1000;
      if (STATE.pressDuration >= STATE.event.detail.duration) onStop();
    }
  }
});

// Particles
(function() {
  for (let i=0; i<15; i++) {
    const p = document.createElement("div"); p.className="particle";
    p.style.left = Math.random()*100+"vw"; p.style.top = Math.random()*100+"vh";
    p.style.width = p.style.height = (4+Math.random()*10)+"px";
    p.style.background = `hsl(${180+Math.random()*60}, 80%, 60%)`;
    p.style.animationDelay = Math.random()*5+"s"; p.style.animationDuration = (6+Math.random()*5)+"s";
    document.body.appendChild(p);
  }
})();
</script>
</body>
</html>